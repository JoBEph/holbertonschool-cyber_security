class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::Tcp
  include Msf::Auxiliary::Scanner

  def initialize(info = {})
    super(update_info(info,
      'Name'    => 'MS17-010 Vulnerability Checker',
      'Author'  => ['JoBEph'],
      'License' => MSF_LICENSE
    ))
    register_options([
      OptPort.new('RPORT', [true, 'The port to scan', 445])
    ])
  end

  def run_host(ip)
    port = datastore['RPORT']
    print_status("Checking #{ip}:#{port} for MS17-010 vulnerability")
    begin
      sock = connect(false, {'RPORT' => port, 'ConnectTimeout' => 0.1})
      if sock
        print_good("#{ip}:#{port} is vulnerable to MS17-010")
        disconnect(sock)
      else
        print_status("#{ip}:#{port} is not vulnerable to MS17-010")
      end
    rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout
      print_status("#{ip}:#{port} is not reachable")
    ensure
      disconnect rescue nil
    end
  end
end
