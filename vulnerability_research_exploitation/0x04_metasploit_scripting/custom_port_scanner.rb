class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::Tcp
  include Msf::Auxiliary::Scanner

  def initialize(info = {})
    super(update_info(info,
      'Name'    => 'Custom port scanner',
      'Author'  => ['JoBEph'],
      'License' => MSF_LICENSE
    ))
    register_options([
        OptInt.new('STARTPORT', [true, 'The Start port', 1]),
        OptInt.new('ENDPORT', [true, 'The End port', 1000])
    ])
  end

  def run_host(ip)
    stpo = datastore['STARTPORT']
    enpo = datastore['ENDPORT']
    open_ports = []
    
    print_status("Running module #{ip}; scanning ports #{stpo}-#{enpo}")
    
    (stpo..enpo).each do |port|
      begin
        sock = connect(false, {'RPORT' => port, 'ConnectTimeout' => 0.1})

        if sock 
          print_good("#{ip}:#{port} - Port #{port} is open on #{ip}")
          open_ports << port
          disconnect(sock)
        end
      rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout
      ensure
        disconnect rescue nil
      end
    end

    if open_ports.any?
      print_status("Open ports on #{ip}: #{open_ports.join(', ')}")
    end
  end
end